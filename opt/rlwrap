#!/usr/bin/env bash

set -euo pipefail

# This script provides a fallback when rlwrap is not installed, allowing Leiningen 1.x and clj REPLs to function
# without requiring the buildpack to install rlwrap as a dependency. Using a REPL on Heroku is rare and typically
# only needed for one-off debugging. Installing rlwrap for all users incurs a cost in build time and slug size
# for very little benefit to the majority of apps. Users who frequently use Leiningen 1.x or clj REPLs can opt-in
# to full readline support by installing rlwrap via the APT buildpack.

# Find the first rlwrap binary on PATH that is not this script. Used to make sure that users who have installed
# rlwrap use the real binary instead of this script.
RLWRAP_BIN=$(command -v -a rlwrap 2>/dev/null | grep -v "^${BASH_SOURCE[0]}$" | head -1 || true)

if [[ -n "${RLWRAP_BIN}" ]]; then
	exec "${RLWRAP_BIN}" "${@}"
else
	cat >&2 <<-EOF
		Warning: Using minimal rlwrap replacement. Command history and line editing are not available.
		To enable full readline support, add the APT buildpack and create an Aptfile:

			1. heroku buildpacks:add --index 1 heroku-community/apt
			2. echo "rlwrap" > Aptfile
			3. git add Aptfile && git commit -m "Add rlwrap support"
			4. git push heroku main

	EOF

	# Strip rlwrap options, leaving only the wrapped command.
	while [[ "${1:-}" == -* ]]; do
		# Options that require an argument need an additional shift.
		case "${1:-}" in
		-a | --always-readline | -b | --break-chars | -C | --command-name | \
		-D | --history-no-dupes | -f | --file | -g | --forget-matching | \
		-H | --history-filename | -l | --logfile | -O | --only-cook | \
		-P | --pre-given | -q | --quote-characters | -s | --histsize | \
		-S | --substitute-prompt | -t | --set-term-name | \
		-w | --wait-before-prompt | -z | --filter)
			shift
			;;
		-m | --multi-line | -p | --prompt-colour)
			# Optional argument: only shift if not another option.
			if [[ "${1:-}" != -* ]]; then
				shift
			fi
			;;
		esac

		shift
	done

	exec "${@}"
fi
