#!/usr/bin/env bash

set -euo pipefail

BUILDPACK_DIR="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

BUILD_DIR="${1}"

# shellcheck source=lib/lein.sh
source "${BUILDPACK_DIR}/lib/lein.sh"

if [[ ! -f "${BUILD_DIR}/Procfile" ]]; then
	cat <<EOF
---
config_vars:
default_process_types:
EOF

	if [[ "$(calculate_lein_build_task "${BUILD_DIR}")" == "uberjar" ]]; then
		cd "${BUILD_DIR}" || exit
		while IFS= read -r -d '' jarFile; do
			echo "  web: java -jar ${jarFile}"
			break
		done < <(find target -maxdepth 1 -name "*.jar" -type f -print0)
	elif is_lein_2 "${BUILD_DIR}"; then
		echo "  web: lein with-profile production trampoline run"
	else
		echo "  web: lein trampoline run"
	fi
fi
