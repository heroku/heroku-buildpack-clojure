#!/usr/bin/env bash

set -euo pipefail

BUILDPACK_DIR="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

BUILD_DIR="${1}"
CACHE_DIR="${2}"
ENV_DIR="${3}"

# shellcheck source=lib/util.sh
source "${BUILDPACK_DIR}/lib/util.sh"
# shellcheck source=lib/lein.sh
source "${BUILDPACK_DIR}/lib/lein.sh"
# shellcheck source=lib/metrics.sh
source "${BUILDPACK_DIR}/lib/metrics.sh"
# shellcheck source=lib/output.sh
source "${BUILDPACK_DIR}/lib/output.sh"
# shellcheck source=lib/openjdk.sh
source "${BUILDPACK_DIR}/lib/openjdk.sh"

util::export_env_dir "${ENV_DIR}" "." "JAVA_OPTS"

metrics::init "${CACHE_DIR}" "clojure"
metrics::setup

if grep -q lein-npm "${BUILD_DIR}/project.clj"; then
	if ! command -v npm &>/dev/null; then
		output::error <<-EOF
			Error: Your project.clj references lein-npm but npm is not available.

			The Clojure buildpack no longer automatically installs Node.js.

			If your project uses the lein-npm plugin, you must explicitly add the Node.js buildpack to provide Node.js and npm.

			To add the Node.js buildpack to your app, run:
			  heroku buildpacks:add --index 1 heroku/nodejs

			For more information, see:
			https://devcenter.heroku.com/articles/nodejs-support
			https://devcenter.heroku.com/articles/managing-buildpacks#use-multiple-buildpacks
		EOF

		metrics::set_string "failure_reason" "lein-npm-without-npm"
		exit 1
	fi
fi

openjdk::install_openjdk_via_jvm_common_buildpack "${BUILD_DIR}" "${BUILDPACK_DIR}"

# Install rlwrap shim for Leiningen 1.x and clj REPLs.
# rlwrap is technically a dependency for both, but it only enhances REPL functionality
# with line editing and command history. This shim allows clj and lein 1.x to run without
# errors, but does not provide actual readline capabilities. Most users don't use REPLs
# in a Heroku context. Users can install their own rlwrap via the APT buildpack and this
# shim will not interfere.
mkdir -p "${BUILD_DIR}/.heroku/bin"
cp "${BUILDPACK_DIR}/opt/rlwrap" "${BUILD_DIR}/.heroku/bin/rlwrap"

# To ensure the cache created by older Clojure buildpack versions doesn't stay around indefinitely, we explicitly
# delete these old directories. This will speed up subsequent app builds since it will take less time to restore
# the cache before each build.
#
# Note: This buildpack used to install and run npm. The node_modules dir is specific to the old Clojure install
#       and does not overlap with the official Node.js buildpack.
rm -rf \
	"${CACHE_DIR}/clojure-bp-apt" \
	"${CACHE_DIR}/node_modules"

# Run clojure install script (clojure / clj may be needed from leiningen for newer cli tools)
CLOJURE_CLI_VERSION="${CLOJURE_CLI_VERSION:-1.10.0.411}"
output::step "Installing Clojure ${CLOJURE_CLI_VERSION} CLI tools"
CLOJURE_INSTALL_NAME="linux-install-${CLOJURE_CLI_VERSION}.sh"
CLOJURE_INSTALL_URL="https://download.clojure.org/install/${CLOJURE_INSTALL_NAME}"
curl --retry 3 --retry-connrefused --connect-timeout 5 -sSfL --max-time 60 -o "/tmp/${CLOJURE_INSTALL_NAME}" "${CLOJURE_INSTALL_URL}"
chmod +x "/tmp/${CLOJURE_INSTALL_NAME}"
mkdir -p "${BUILD_DIR}/.heroku/clj"
"/tmp/${CLOJURE_INSTALL_NAME}" --prefix "${BUILD_DIR}/.heroku/clj" 2>/dev/null | output::indent
chmod +x "${BUILD_DIR}/.heroku/clj/bin/"*
export PATH="${BUILD_DIR}/.heroku/clj/bin:${PATH}"

# Check for vendored lein script
if [[ -x "${BUILD_DIR}/bin/lein" ]]; then
	output::step "Using vendored Leiningen at bin/lein"
	LEIN_BIN_PATH="${BUILD_DIR}/bin/lein"
	calculate_lein_build_task "${BUILD_DIR}"
	"${LEIN_BIN_PATH}" version 2>/dev/null | output::indent
else
	# Determine Leiningen version
	if is_lein_2 "${BUILD_DIR}"; then
		LEIN_VERSION="2.9.1"
		LEIN_BIN_SOURCE="$(dirname "${0}")/../opt/lein2"
		calculate_lein_build_task "${BUILD_DIR}"
	else
		LEIN_VERSION="1.7.1"
		LEIN_BIN_SOURCE="$(dirname "${0}")/../opt/lein1"
		LEIN_BUILD_TASK="${LEIN_BUILD_TASK:-deps}"
		if [[ -z "${LEIN_DEV:-}" ]]; then
			export LEIN_NO_DEV=y
		fi
		export RLWRAP=yes
		output::warning <<-EOF
			WARNING: No :min-lein-version found in project.clj; using ${LEIN_VERSION}.
			You probably don't want this!
		EOF
	fi

	# install leiningen jar
	LEIN1_JAR_URL="https://lang-jvm.s3.us-east-1.amazonaws.com/leiningen-${LEIN_VERSION}-standalone.jar"
	LEIN2_JAR_URL="https://github.com/technomancy/leiningen/releases/download/${LEIN_VERSION}/leiningen-${LEIN_VERSION}-standalone.zip"
	LEIN_JAR_CACHE_PATH="${CACHE_DIR}/leiningen-${LEIN_VERSION}-standalone.jar"
	LEIN_JAR_SLUG_PATH="${BUILD_DIR}/.lein/leiningen-${LEIN_VERSION}-standalone.jar"

	if [[ "${LEIN_VERSION}" = "1.7.1" ]]; then
		LEIN_JAR_URL="${LEIN1_JAR_URL}"
	else
		LEIN_JAR_URL="${LEIN2_JAR_URL}"
	fi

	if [[ ! -r "${LEIN_JAR_CACHE_PATH}" ]]; then
		output::step "Installing Leiningen"
		echo "       Downloading: leiningen-${LEIN_VERSION}-standalone.jar"
		mkdir -p "$(dirname "${LEIN_JAR_CACHE_PATH}")"
		curl --fail --retry 3 --retry-connrefused --connect-timeout 5 --silent --show-error --max-time 120 -L -o "${LEIN_JAR_CACHE_PATH}" "${LEIN_JAR_URL}"
	else
		output::step "Using cached Leiningen ${LEIN_VERSION}"
	fi

	if [[ "${LEIN_VERSION}" = "1.7.1" ]]; then
		echo "       To use Leiningen 2.x, add this to project.clj: :min-lein-version \"2.0.0\""
	fi

	mkdir -p "${BUILD_DIR}/.lein"
	cp "${LEIN_JAR_CACHE_PATH}" "${LEIN_JAR_SLUG_PATH}"

	# install lein script
	LEIN_BIN_PATH="${BUILD_DIR}/.lein/bin/lein"
	echo "       Writing: lein script"
	mkdir -p "$(dirname "${LEIN_BIN_PATH}")"
	cp "${LEIN_BIN_SOURCE}" "${LEIN_BIN_PATH}"
	sed -i s/##LEIN_VERSION##/"${LEIN_VERSION}"/ "${LEIN_BIN_PATH}"
fi

# Collect metrics
metrics::set_string "lein_version" "${LEIN_VERSION:-unknown}"
metrics::set_string "clojure_cli_version" "${CLOJURE_CLI_VERSION:-1.10.0.411}"
[[ -n "${LEIN_INCLUDE_IN_SLUG:-}" ]] && metrics::set_string "lein_include_in_slug" "${LEIN_INCLUDE_IN_SLUG}"
[[ -n "${LEIN_BUILD_TASK:-}" ]] && metrics::set_string "lein_build_task" "${LEIN_BUILD_TASK}"

# create user-level profiles
mkdir -p "${BUILD_DIR}/.lein"
if [[ ! -e "${BUILD_DIR}/.lein/profiles.clj" ]]; then
	echo '{}' >"${BUILD_DIR}/.lein/profiles.clj"
fi

# unpack existing cache
if [[ ! -d "${BUILD_DIR}/.m2" ]]; then
	util::cache_copy ".m2" "${CACHE_DIR}" "${BUILD_DIR}"
fi

output::step "Building with Leiningen"

# Calculate build command
if [[ -z "${BUILD_COMMAND:-}" ]]; then
	if [[ -x "${BUILD_DIR}/bin/build" ]]; then
		echo "       Found bin/build; running it instead of default lein invocation."
		BUILD_COMMAND=bin/build
	else
		BUILD_COMMAND="lein ${LEIN_BUILD_TASK}"
	fi
fi

metrics::set_string "build_command" "${BUILD_COMMAND}"

echo "       Running: ${BUILD_COMMAND}"

cd "${BUILD_DIR}"
if ! PATH="$(dirname "${LEIN_BIN_PATH}"):${PATH}" JVM_OPTS="-Xmx600m" \
HTTP_CLIENT="curl --location --connect-timeout 3 --max-time 60 --retry 5 --retry-connrefused --no-progress-meter --fail -o" \
LEIN_JVM_OPTS="-Xmx400m -Duser.home=${BUILD_DIR}" \
	${BUILD_COMMAND} 2>&1 | output::indent; then
	output::error <<-EOF
		Failed to build.
	EOF
	exit 1
fi

# populate profile.d
PROFILE_PATH="${BUILD_DIR}/.profile.d/clojure.sh"
mkdir -p "$(dirname "${PROFILE_PATH}")"
{
	echo "export LEIN_NO_DEV=\"\${LEIN_NO_DEV:-yes}\""
	echo "export PATH=\"\$HOME/.heroku/bin:\$HOME/.heroku/clj/bin:\$HOME/.jdk/bin:\$HOME/.lein/bin:\$PATH\""
	echo "export RING_ENV=\"\${RING_ENV:-production}\""
} >>"${PROFILE_PATH}"

# rewrite Clojure CLI path
mv "${BUILD_DIR}/.heroku/clj/bin/clojure" "${BUILD_DIR}/.heroku/clj/bin/clojure.old"
sed -e "s/\/tmp\/$(basename "${BUILD_DIR}")/\/app/g" "${BUILD_DIR}/.heroku/clj/bin/clojure.old" >"${BUILD_DIR}/.heroku/clj/bin/clojure"
chmod +x "${BUILD_DIR}/.heroku/clj/bin/clojure"

# repack cache with new assets
mkdir -p "${CACHE_DIR}"
util::cache_copy ".m2" "${BUILD_DIR}" "${CACHE_DIR}"

if [[ "${LEIN_INCLUDE_IN_SLUG:-}" = "no" ]]; then
	if [[ -n "${LEIN_JAR_SLUG_PATH:-}" ]]; then
		rm -f "${LEIN_JAR_SLUG_PATH}"
	fi
	rm -rf "${BUILD_DIR}/.m2"
fi

if [[ "${LEIN_VERSION:-}" = "1.7.1" ]]; then
	rm -rf "${BUILD_DIR}/.m2"
fi
