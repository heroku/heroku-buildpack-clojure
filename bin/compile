#!/usr/bin/env bash

set -euo pipefail

BUILDPACK_DIR="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

BUILD_DIR="${1}"
CACHE_DIR="${2}"
ENV_DIR="${3}"

# shellcheck source=lib/util.sh
source "${BUILDPACK_DIR}/lib/util.sh"
# shellcheck source=lib/metrics.sh
source "${BUILDPACK_DIR}/lib/metrics.sh"
# shellcheck source=lib/output.sh
source "${BUILDPACK_DIR}/lib/output.sh"
# shellcheck source=lib/openjdk.sh
source "${BUILDPACK_DIR}/lib/openjdk.sh"

util::export_env_dir "${ENV_DIR}" "." "JAVA_OPTS"

metrics::init "${CACHE_DIR}" "clojure"
metrics::setup

# To ensure the cache created by older Clojure buildpack versions doesn't stay around indefinitely, we explicitly
# delete these old directories. This will speed up subsequent app builds since it will take less time to restore
# the cache before each build.
#
# Note: This buildpack used to install and run npm. The node_modules dir is specific to the old Clojure install
#       and does not overlap with the official Node.js buildpack.
# Note: This buildpack used to download Leiningen jars to the cache. These are no longer needed.
rm -rf \
	"${CACHE_DIR}/clojure-bp-apt" \
	"${CACHE_DIR}/node_modules" \
	"${CACHE_DIR}"/leiningen-*-standalone.jar

openjdk::install_openjdk_via_jvm_common_buildpack "${BUILD_DIR}" "${BUILDPACK_DIR}"

util::cache_copy ".m2" "${CACHE_DIR}" "${BUILD_DIR}"

# Install rlwrap shim for Leiningen 1.x and clj REPLs.
# rlwrap is technically a dependency for both, but it only enhances REPL functionality
# with line editing and command history. This shim allows clj and lein 1.x to run without
# errors, but does not provide actual readline capabilities. Most users don't use REPLs
# in a Heroku context. Users can install their own rlwrap via the APT buildpack and this
# shim will not interfere.
mkdir -p "${BUILD_DIR}/.heroku/bin"
cp "${BUILDPACK_DIR}/opt/rlwrap" "${BUILD_DIR}/.heroku/bin/rlwrap"

# Run clojure install script (clojure / clj may be needed from leiningen for newer cli tools)
CLOJURE_CLI_VERSION="${CLOJURE_CLI_VERSION:-1.12.4.1582}"

output::step "Installing Clojure ${CLOJURE_CLI_VERSION} CLI tools"

CLOJURE_INSTALL_SCRIPT="$(mktemp)"
curl --retry 3 --retry-connrefused --connect-timeout 5 -sSfL --max-time 60 -o "${CLOJURE_INSTALL_SCRIPT}" "https://download.clojure.org/install/linux-install-${CLOJURE_CLI_VERSION}.sh"
chmod +x "${CLOJURE_INSTALL_SCRIPT}"

# Clojure CLI is non-portable as it embeds absolute paths during installation.
# Create a symlink before installation to ensure those paths work at both compile and runtime.
CLOJURE_CLI_DIR=".heroku/clj"
mkdir -p "${BUILD_DIR}/${CLOJURE_CLI_DIR}"
if [[ "$(realpath "${BUILD_DIR}")" != "$(realpath /app)" ]]; then
	mkdir -p "/app/$(dirname "${CLOJURE_CLI_DIR}")"
	ln -nsf "${BUILD_DIR}/${CLOJURE_CLI_DIR}" "/app/${CLOJURE_CLI_DIR}"
fi

"${CLOJURE_INSTALL_SCRIPT}" --prefix "/app/${CLOJURE_CLI_DIR}" 2>/dev/null | output::indent
chmod +x "/app/${CLOJURE_CLI_DIR}/bin/"*
export PATH="/app/${CLOJURE_CLI_DIR}/bin:${PATH}"

# Pre-warm Clojure CLI cache to avoid download messages for its own dependencies when its used for the first time by
# the buildpack or the user at runtime.
clojure -e "(println)" &>/dev/null

output::step "Reading Leiningen project properties"

lein_project_plugins=$("${BUILDPACK_DIR}/opt/get_project_property.clj" "${BUILD_DIR}/project.clj" "plugins")
lein_project_min_lein_version=$("${BUILDPACK_DIR}/opt/get_project_property.clj" "${BUILD_DIR}/project.clj" "min-lein-version")

lein_project_uberjar_name=$("${BUILDPACK_DIR}/opt/get_project_property.clj" "${BUILD_DIR}/project.clj" "uberjar-name")
# The :uberjar profile is automatically activated by Leiningen when running "lein uberjar".
# Check for :uberjar-name inside this profile if it's not defined at the top level.
if [[ -z "${lein_project_uberjar_name}" ]]; then
	lein_project_uberjar_name=$("${BUILDPACK_DIR}/opt/get_project_property.clj" "${BUILD_DIR}/project.clj" "profiles" "uberjar" "uberjar-name")
fi

if grep -q lein-npm <<<"${lein_project_plugins}"; then
	if ! command -v npm &>/dev/null; then
		output::error <<-EOF
			Error: Your project.clj references lein-npm but npm is not available.

			The Clojure buildpack no longer automatically installs Node.js.

			If your project uses the lein-npm plugin, you must explicitly add the Node.js buildpack to provide Node.js and npm.

			To add the Node.js buildpack to your app, run:
			  heroku buildpacks:add --index 1 heroku/nodejs

			For more information, see:
			https://devcenter.heroku.com/articles/nodejs-support
			https://devcenter.heroku.com/articles/managing-buildpacks#use-multiple-buildpacks
		EOF

		metrics::set_string "failure_reason" "lein-npm-without-npm"
		exit 1
	fi
fi

# Check for vendored lein script
if [[ -x "${BUILD_DIR}/bin/lein" ]]; then
	output::step "Using vendored Leiningen at bin/lein"
	LEIN_BIN_PATH="${BUILD_DIR}/bin/lein"
	if [[ -n "${lein_project_uberjar_name}" ]]; then
		export LEIN_BUILD_TASK="${LEIN_BUILD_TASK:-uberjar}"
		export LEIN_INCLUDE_IN_SLUG="${LEIN_INCLUDE_IN_SLUG:-no}"
	else
		export LEIN_BUILD_TASK="${LEIN_BUILD_TASK:-with-profile production compile :all}"
	fi
	"${LEIN_BIN_PATH}" version 2>/dev/null | output::indent
else
	# Fail if Leiningen version is less than 2.0
	case "${lein_project_min_lein_version}" in
	"" | 1*)
		output::error <<-EOF
			Error: Leiningen 1.x is no longer supported by this buildpack.

			Please upgrade to Leiningen 2.x by setting :min-lein-version in your project.clj:

			  (defproject your-project "version"
			    :min-lein-version "2.0.0"
			    ...)

			If you need to use a custom Leiningen version, you can vendor the lein script
			in your repository at bin/build.

			For more information, see:
			https://web.archive.org/web/20160225024908/https://github.com/technomancy/leiningen/wiki/Upgrading
		EOF

		metrics::set_string "failure_reason" "lein-version-not-supported"
		exit 1
		;;
	2*)
		LEIN_VERSION="2.12.0"
		if [[ -n "${lein_project_uberjar_name}" ]]; then
			export LEIN_BUILD_TASK="${LEIN_BUILD_TASK:-uberjar}"
			export LEIN_INCLUDE_IN_SLUG="${LEIN_INCLUDE_IN_SLUG:-no}"
		else
			export LEIN_BUILD_TASK="${LEIN_BUILD_TASK:-with-profile production compile :all}"
		fi
		;;
	esac

	output::step "Installing Leiningen ${LEIN_VERSION}"

	LEIN_BIN_PATH="${BUILD_DIR}/.lein/bin/lein"
	LEIN_SCRIPT_URL="https://codeberg.org/leiningen/leiningen/raw/tag/${LEIN_VERSION}/bin/lein"

	mkdir -p "$(dirname "${LEIN_BIN_PATH}")"
	curl --fail --retry 3 --retry-connrefused --connect-timeout 5 --silent --show-error --max-time 60 -L -o "${LEIN_BIN_PATH}" "${LEIN_SCRIPT_URL}"
	chmod +x "${LEIN_BIN_PATH}"
fi

# Collect metrics
metrics::set_string "lein_version" "${LEIN_VERSION:-unknown}"
metrics::set_string "clojure_cli_version" "${CLOJURE_CLI_VERSION:-1.10.0.411}"
[[ -n "${LEIN_INCLUDE_IN_SLUG:-}" ]] && metrics::set_string "lein_include_in_slug" "${LEIN_INCLUDE_IN_SLUG}"
[[ -n "${LEIN_BUILD_TASK:-}" ]] && metrics::set_string "lein_build_task" "${LEIN_BUILD_TASK}"

# create user-level profiles
mkdir -p "${BUILD_DIR}/.lein"
if [[ ! -e "${BUILD_DIR}/.lein/profiles.clj" ]]; then
	echo '{}' >"${BUILD_DIR}/.lein/profiles.clj"
fi

output::step "Building with Leiningen"

# Calculate build command
if [[ -z "${BUILD_COMMAND:-}" ]]; then
	if [[ -x "${BUILD_DIR}/bin/build" ]]; then
		echo "       Found bin/build; running it instead of default lein invocation."
		BUILD_COMMAND=bin/build
	else
		BUILD_COMMAND="lein ${LEIN_BUILD_TASK}"
	fi
fi

metrics::set_string "build_command" "${BUILD_COMMAND}"

echo "       Running: ${BUILD_COMMAND}"

cd "${BUILD_DIR}"
if ! PATH="$(dirname "${LEIN_BIN_PATH}"):${PATH}" JVM_OPTS="-Xmx600m" \
HTTP_CLIENT="curl --location --connect-timeout 3 --max-time 60 --retry 5 --retry-connrefused --no-progress-meter --fail -o" \
LEIN_JVM_OPTS="-Xmx400m -Duser.home=${BUILD_DIR}" \
	${BUILD_COMMAND} 2>&1 | output::indent; then
	output::error <<-EOF
		Failed to build.
	EOF
	exit 1
fi

# populate profile.d
PROFILE_PATH="${BUILD_DIR}/.profile.d/clojure.sh"
mkdir -p "$(dirname "${PROFILE_PATH}")"
{
	echo "export LEIN_NO_DEV=\"\${LEIN_NO_DEV:-yes}\""
	echo "export PATH=\"\$HOME/.heroku/bin:\$HOME/.heroku/clj/bin:\$HOME/.jdk/bin:\$HOME/.lein/bin:\$PATH\""
	echo "export RING_ENV=\"\${RING_ENV:-production}\""
} >>"${PROFILE_PATH}"

# Write export script for use by subsequent buildpacks. The export script sets up the environment so that other
# buildpacks in the chain can access Clojure CLI and Leiningen during their build phase. This script
# is sourced by the buildpack framework between buildpack executions.
cat <<-EOF >>"${BUILDPACK_DIR}/export"
	export PATH="/app/.heroku/bin:/app/${CLOJURE_CLI_DIR}/bin:/app/.lein/bin:\${PATH}"
EOF

# repack cache with new assets
mkdir -p "${CACHE_DIR}"
util::cache_copy ".m2" "${BUILD_DIR}" "${CACHE_DIR}"

if [[ "${LEIN_INCLUDE_IN_SLUG:-}" = "no" ]]; then
	rm -rf "${BUILD_DIR}/.m2"
fi
