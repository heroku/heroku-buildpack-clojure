#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BPLOG_PREFIX="buildpack.clojure"

# parse args
export BUILD_DIR=$1
export CACHE_DIR=$2
export ENV_DIR=$3

BP_DIR=$(cd $(dirname $0)/..; pwd)
BIN_DIR=$BP_DIR/bin
LIB_DIR=$BP_DIR/lib

source $LIB_DIR/common.sh
source $LIB_DIR/lein.sh
source <(curl --retry 3 -fsSL $BUILDPACK_STDLIB_URL)

export_env $ENV_DIR "." "JAVA_OPTS"

# Install JDK from jvm-common
install_jdk ${BUILD_DIR}

# Install Node.js if needed
detect_and_install_nodejs ${BUILD_DIR}

# install rlwrap binary, always needed for clj command, and also on old lein 1.x
install_rlwrap "${BUILD_DIR}" "${CACHE_DIR}"

# Run clojure install script (clojure / clj may be needed from leiningen for newer cli tools)
CLOJURE_CLI_VERSION="${CLOJURE_CLI_VERSION:-1.10.0.411}"
echo "-----> Installing Clojure $CLOJURE_CLI_VERSION CLI tools"
CLOJURE_INSTALL_NAME="linux-install-${CLOJURE_CLI_VERSION}.sh"
CLOJURE_INSTALL_URL="https://download.clojure.org/install/$CLOJURE_INSTALL_NAME"
curl --retry 3 -sfL --max-time 60 -o "/tmp/$CLOJURE_INSTALL_NAME" "$CLOJURE_INSTALL_URL"
chmod +x /tmp/$CLOJURE_INSTALL_NAME
mkdir -p $BUILD_DIR/.heroku/clj
"/tmp/$CLOJURE_INSTALL_NAME" --prefix $BUILD_DIR/.heroku/clj 2>/dev/null | sed -u 's/^/       /'
chmod +x $BUILD_DIR/.heroku/clj/bin/*
export PATH=$BUILD_DIR/.heroku/clj/bin:$PATH

# Check for vendored lein script
if [ -x $BUILD_DIR/bin/lein ]; then
  echo "-----> Using vendored Leiningen at bin/lein"
  LEIN_BIN_PATH="$BUILD_DIR/bin/lein"
  calculate_lein_build_task $BUILD_DIR
  $LEIN_BIN_PATH version 2>/dev/null | sed -u 's/^/       /'
else
  # Determine Leiningen version
  if is_lein_2 $BUILD_DIR; then
    LEIN_VERSION="2.9.1"
    LEIN_BIN_SOURCE="$(dirname $0)/../opt/lein2"
    calculate_lein_build_task $BUILD_DIR
  else
    LEIN_VERSION="1.7.1"
    LEIN_BIN_SOURCE="$(dirname $0)/../opt/lein1"
    LEIN_BUILD_TASK=${LEIN_BUILD_TASK:-"deps"}
    if [ "$LEIN_DEV" = "" ]; then
      export LEIN_NO_DEV=y
    fi
    RLWRAP=yes
    warning "No :min-lein-version found in project.clj; using $LEIN_VERSION.
  You probably don't want this!"
  fi

  # install leiningen jar
  LEIN1_JAR_URL="https://lang-jvm.s3.amazonaws.com/leiningen-$LEIN_VERSION-standalone.jar"
  LEIN2_JAR_URL="https://github.com/technomancy/leiningen/releases/download/$LEIN_VERSION/leiningen-$LEIN_VERSION-standalone.zip"
  LEIN_JAR_CACHE_PATH="$CACHE_DIR/leiningen-$LEIN_VERSION-standalone.jar"
  LEIN_JAR_SLUG_PATH="$BUILD_DIR/.lein/leiningen-$LEIN_VERSION-standalone.jar"

  if [ "$LEIN_VERSION" = "1.7.1" ]; then
    LEIN_JAR_URL=$LEIN1_JAR_URL
  else
    LEIN_JAR_URL=$LEIN2_JAR_URL
  fi

  if [ ! -r "$LEIN_JAR_CACHE_PATH" ]; then
    echo "-----> Installing Leiningen"
    echo "       Downloading: leiningen-$LEIN_VERSION-standalone.jar"
    mkdir -p $(dirname $LEIN_JAR_CACHE_PATH)
    curl --retry 3 --silent --show-error --max-time 120 -L -o "$LEIN_JAR_CACHE_PATH" $LEIN_JAR_URL
  else
    echo "-----> Using cached Leiningen $LEIN_VERSION"
  fi

  if [ "$LEIN_VERSION" = "1.7.1" ]; then
    echo "       To use Leiningen 2.x, add this to project.clj: :min-lein-version \"2.0.0\""
  fi

  mkdir -p "$BUILD_DIR/.lein"
  cp "$LEIN_JAR_CACHE_PATH" "$LEIN_JAR_SLUG_PATH"

  # install lein script
  LEIN_BIN_PATH=$BUILD_DIR"/.lein/bin/lein"
  echo "       Writing: lein script"
  mkdir -p $(dirname $LEIN_BIN_PATH)
  cp $LEIN_BIN_SOURCE $LEIN_BIN_PATH
  sed -i s/##LEIN_VERSION##/$LEIN_VERSION/ $LEIN_BIN_PATH
fi

# create user-level profiles
mkdir -p $BUILD_DIR/.lein
LEIN_PROFILES_SOURCE="$(dirname $0)/../opt/profiles.clj"
cp -n $LEIN_PROFILES_SOURCE "$BUILD_DIR/.lein/profiles.clj"

# Setup SSH agent and private key
eval $(ssh-agent -s)
ssh-add - <<< "${DEPLOY_KEY}"

echo "-----> Authorize SSH host"
mkdir -p ~/.ssh
chmod 0700 ~/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts

echo "-----> Installing Babashka"
# install babashka
BABASHKA_VERSION="${BABASHKA_VERSION:-0.7.0}"
echo "-----> Installing Babashka $BABASHKA_VERSION"

curl -sLO https://raw.githubusercontent.com/babashka/babashka/master/install
chmod +x install
./install --dir $BUILD_DIR/.heroku --version $BABASHKA_VERSION
chmod +x $BUILD_DIR/.heroku/bb
export PATH=$BUILD_DIR/.heroku/:$PATH

echo "-----> Check babashka installation"
bb version

echo "-----> Build uberjar using babashka"
cd $BUILD_DIR
bb build:uberjar
